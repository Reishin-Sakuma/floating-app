# TASK-201: 設定画面UI - 詳細要件定義

## 概要

Windowsアプリケーションとして適切な設定画面UIを実装する。tkinterベースで直感的な操作感と優れたユーザビリティを提供し、
ConfigManagerと密接に連携してリアルタイムな設定変更・保存機能を実現する。

## 要件詳細

### REQ-201: 基本設定UI
- Windows標準のダイアログスタイルで統一感のある設定画面
- タブレイアウトによる機能別設定項目の整理
- 即座にプレビューできるリアルタイム設定反映
- 設定変更時の自動保存とキャンセル機能

### REQ-202: アプリケーション選択機能
- ファイルダイアログによる実行ファイル選択
- 選択したファイルの検証とプレビュー表示
- よく使用するアプリケーションの履歴管理
- 無効なファイル選択時の適切なエラー表示

### REQ-203: アイコン位置設定
- 数値入力による正確な位置指定
- ドラッグ操作による直感的な位置変更
- プレビューエリアでの位置確認機能
- マルチモニター環境への対応

### REQ-204: 高度な設定項目
- アイコンサイズの調整（スライダー + 数値入力）
- 透明度・影効果などの外観設定
- 自動起動設定の有効/無効
- ホットキー設定（将来拡張）

### REQ-205: UI応答性とフィードバック
- 設定変更の即座なプレビュー反映
- 進行状況の表示（ファイル選択・保存処理）
- エラー・警告メッセージの適切な表示
- 操作のキャンセルと元に戻す機能

## 実装インターフェース

### SettingsWindow クラス

```python
class SettingsWindow:
    def __init__(self, config_manager: ConfigManager, floating_icon: FloatingIcon = None):
        """設定ウィンドウの初期化"""
        pass
    
    def show(self) -> None:
        """設定ウィンドウを表示する"""
        pass
    
    def hide(self) -> None:
        """設定ウィンドウを非表示にする"""
        pass
    
    def apply_settings(self) -> bool:
        """現在の設定を適用・保存する"""
        pass
    
    def cancel_settings(self) -> None:
        """設定変更をキャンセルして元に戻す"""
        pass
    
    def reset_to_defaults(self) -> None:
        """設定をデフォルト値にリセットする"""
        pass
    
    def validate_settings(self) -> tuple[bool, list[str]]:
        """現在の設定を検証する"""
        pass
    
    def get_current_settings(self) -> dict:
        """現在のUI状態から設定を取得する"""
        pass
    
    def load_settings_to_ui(self, config: dict) -> None:
        """設定をUIに反映する"""
        pass
```

### SettingsTab クラス（基底クラス）

```python
class SettingsTab:
    def __init__(self, parent: tk.Widget, config_manager: ConfigManager):
        """設定タブの基底クラス"""
        pass
    
    def create_widgets(self) -> tk.Frame:
        """タブのウィジェットを作成する"""
        pass
    
    def get_values(self) -> dict:
        """タブの設定値を取得する"""
        pass
    
    def set_values(self, values: dict) -> None:
        """タブに設定値を設定する"""
        pass
    
    def validate(self) -> tuple[bool, list[str]]:
        """タブの設定値を検証する"""
        pass
    
    def reset_to_defaults(self) -> None:
        """タブをデフォルト値にリセットする"""
        pass
```

### ApplicationTab クラス

```python
class ApplicationTab(SettingsTab):
    """アプリケーション選択タブ"""
    
    def browse_application(self) -> None:
        """ファイルダイアログでアプリケーションを選択"""
        pass
    
    def validate_application_path(self, path: str) -> tuple[bool, str]:
        """アプリケーションパスを検証"""
        pass
    
    def get_application_info(self, path: str) -> dict:
        """アプリケーション情報を取得"""
        pass
```

### AppearanceTab クラス

```python
class AppearanceTab(SettingsTab):
    """外観設定タブ"""
    
    def update_position_preview(self) -> None:
        """位置プレビューを更新"""
        pass
    
    def update_size_preview(self) -> None:
        """サイズプレビューを更新"""
        pass
    
    def on_position_drag(self, event) -> None:
        """ドラッグによる位置変更"""
        pass
```

### GeneralTab クラス

```python
class GeneralTab(SettingsTab):
    """一般設定タブ"""
    
    def toggle_auto_start(self) -> None:
        """自動起動設定の切り替え"""
        pass
    
    def test_hotkey(self) -> None:
        """ホットキー設定のテスト"""
        pass
```

## GUI設計要件

### ウィンドウ構成

#### メインウィンドウ
- **サイズ**: 600x500 ピクセル（最小400x350）
- **位置**: 画面中央配置
- **リサイズ**: 有効（最小サイズ制限あり）
- **タイトルバー**: "設定 - フローティングランチャー"

#### タブレイアウト
1. **アプリケーション**タブ
2. **外観**タブ  
3. **一般**タブ

#### ボタンレイアウト
- **OK**: 設定を保存して閉じる
- **キャンセル**: 変更を破棄して閉じる
- **適用**: 設定を保存（ウィンドウは開いたまま）
- **デフォルト**: 全設定をデフォルト値にリセット

### アプリケーションタブ UI

#### 起動アプリケーション選択
```
┌─ 起動アプリケーション ─────────────────────────────┐
│ パス: [C:\Program Files\example\app.exe     ] [参照] │
│                                                    │
│ ┌─ アプリケーション情報 ─────────────────────┐     │
│ │ 名前: Example Application                  │     │
│ │ バージョン: 1.0.0                         │     │
│ │ ファイルサイズ: 2.1 MB                    │     │
│ │ 作成日時: 2024-01-15 10:30                │     │
│ └─────────────────────────────────────────┘     │
└──────────────────────────────────────────────────┘

┌─ 履歴 ───────────────────────────────────────────┐
│ □ C:\Windows\System32\notepad.exe                  │
│ □ C:\Program Files\VSCode\Code.exe                 │
│ □ C:\Program Files\Google\Chrome\chrome.exe        │
│                                          [クリア] │
└──────────────────────────────────────────────────┘
```

#### 起動オプション
```
┌─ 起動オプション ───────────────────────────────────┐
│ コマンドライン引数: [                             ] │
│ 作業ディレクトリ:   [                             ] │
│                                                    │
│ □ 管理者権限で実行                                 │
│ □ ウィンドウを最小化して起動                       │
│ □ アプリケーション終了時にランチャーも終了         │
└──────────────────────────────────────────────────┘
```

### 外観タブ UI

#### 位置設定
```
┌─ アイコン位置 ─────────────────────────────────────┐
│ X座標: [200  ] px    Y座標: [150  ] px              │
│                                                    │
│ ┌─ プレビュー ─────────────────────────────────┐   │
│ │                                ● ←アイコン  │   │
│ │                                              │   │
│ │                                              │   │
│ │                                              │   │
│ │                                              │   │
│ └──────────────────────────────────────────────┘   │
│                                   [位置をリセット] │
└──────────────────────────────────────────────────┘
```

#### サイズ・外観設定
```
┌─ アイコン外観 ─────────────────────────────────────┐
│ サイズ: [■■■■■■■□□□] 32px                      │
│                                                    │
│ □ ドロップシャドウを表示                           │
│ □ ホバー時にハイライト表示                         │
│ 透明度: [■■■■■■■■■□] 90%                      │
│                                                    │
│ テーマ: [○ 明るい ○ 暗い ● 自動]                  │
└──────────────────────────────────────────────────┘
```

### 一般タブ UI

#### システム統合
```
┌─ システム統合 ─────────────────────────────────────┐
│ □ Windows起動時に自動で開始                        │
│ □ システムトレイに常駐                             │
│ □ 終了時に設定を自動保存                           │
│                                                    │
│ 言語: [日本語 ▼]                                   │
└──────────────────────────────────────────────────┘
```

#### ホットキー設定（将来拡張）
```
┌─ ホットキー設定 ───────────────────────────────────┐
│ アプリケーション起動: [Ctrl + Alt + L] [設定]      │
│ 設定画面を表示:      [なし            ] [設定]      │
│ ランチャーを終了:    [なし            ] [設定]      │
└──────────────────────────────────────────────────┘
```

## UX/UI設計原則

### Windows標準準拠
- **フォント**: Segoe UI, 9pt (日本語: Yu Gothic UI)
- **色**: Windows標準システムカラー
- **アイコン**: Windows標準アイコンスタイル
- **間隔**: Windows HIGに準拠した余白・マージン

### アクセシビリティ
- **Tab順序**: 論理的なフォーカス移動
- **キーボードショートカット**: 主要操作のキー割り当て
- **高コントラスト**: システム設定への対応
- **読み上げ**: スクリーンリーダー対応（将来拡張）

### レスポンシブ性
- **即時フィードバック**: 設定変更の即座なプレビュー
- **進行状況表示**: 時間のかかる操作の進捗表示
- **エラー表示**: インライン・適切な位置でのエラーメッセージ
- **状態保持**: ダイアログ閉じても一時設定を記憶

## 技術実装要件

### tkinter実装要件
- **ttk**: 現代的な外観のためのテーマ対応ウィジェット使用
- **ジオメトリマネージャー**: grid()による構造化レイアウト
- **バインディング**: 適切なイベント処理とコールバック
- **バリデーション**: リアルタイム入力検証

### 設定管理連携
- **ConfigManager統合**: 設定の読み込み・保存・検証
- **リアルタイム反映**: FloatingIconとの即座な連携
- **競合回避**: 複数ウィンドウでの設定変更管理
- **バックアップ**: 設定変更時の自動バックアップ

### エラーハンドリング
- **ファイル選択エラー**: 無効なファイル・権限不足の処理
- **設定値エラー**: 範囲外・無効値の適切な処理
- **保存エラー**: ディスク容量・権限等のエラー対応
- **復旧機能**: エラー発生時の設定復旧

## テスト要件

### 視覚テスト
- **レイアウト確認**: 各解像度での表示確認
- **フォント・色**: 異なるシステム設定での外観確認
- **高DPI対応**: 各スケーリング設定での表示確認
- **テーマ対応**: ライト・ダークテーマでの表示確認

### 機能テスト
- **設定保存・読み込み**: 全設定項目の正常動作確認
- **バリデーション**: 無効値入力時の適切な処理確認
- **ファイル選択**: ファイルダイアログとパス検証確認
- **プレビュー機能**: 設定変更の即座な反映確認

### 統合テスト
- **ConfigManager連携**: 設定システム全体の動作確認
- **FloatingIcon連携**: 設定変更の実際の反映確認
- **マルチウィンドウ**: 複数ウィンドウでの競合処理確認
- **システム統合**: OS機能との適切な連携確認

## パフォーマンス要件

### 応答性要件
- **ウィンドウ表示**: 0.5秒以内
- **設定変更反映**: 0.1秒以内（プレビュー）
- **ファイルダイアログ**: 1秒以内の表示
- **設定保存**: 0.2秒以内

### リソース使用量
- **メモリ使用**: 追加5MB以下
- **CPU使用**: アイドル時0%
- **ディスクI/O**: 設定保存時のみ
- **UI応答**: ノンブロッキング実装

## セキュリティ要件

### 入力検証
- **ファイルパス**: パストラバーサル攻撃の防止
- **設定値**: 範囲・形式の厳密な検証
- **特殊文字**: 危険な文字列の無害化
- **権限チェック**: 実行権限の確認

### 設定保護
- **適切な権限**: 設定ファイルの適切なアクセス権
- **バックアップ**: 重要設定の自動バックアップ
- **復旧機能**: 破損時の自動復旧
- **競合回避**: 同時アクセス時の整合性保証

## 完了条件

1. **機能要件**:
   - [ ] 全設定項目が正常に動作する
   - [ ] ファイル選択と検証が正確に機能する
   - [ ] プレビュー機能が即座に反映される
   - [ ] 設定の保存・読み込みが確実に動作する

2. **品質要件**:
   - [ ] Windows標準UIと統一感がある
   - [ ] 直感的で使いやすいユーザビリティ
   - [ ] 適切なエラーハンドリングと表示
   - [ ] 高DPI・マルチモニター環境での正常動作

3. **統合要件**:
   - [ ] ConfigManagerとの完全連携
   - [ ] FloatingIconとのリアルタイム連携
   - [ ] 他システムコンポーネントとの協調動作
   - [ ] アクセシビリティ要件の満足

## 実装方針

### 段階的実装
1. **基本ウィンドウ**: tkinterベースの基本設定ウィンドウ
2. **タブレイアウト**: 各設定項目のタブ構成
3. **アプリケーション選択**: ファイルダイアログと検証機能
4. **外観設定**: 位置・サイズ・プレビュー機能
5. **統合機能**: 他コンポーネントとの連携
6. **UI改善**: アクセシビリティ・レスポンシブ性向上

### 品質重視
- すべての機能の包括的テスト
- ユーザビリティの継続的改善
- Windows標準への準拠確保
- パフォーマンス要件の達成確認