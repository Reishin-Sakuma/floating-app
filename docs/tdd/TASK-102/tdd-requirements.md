# TASK-102: フローティングアイコン描画エンジン - 詳細要件定義

## 概要

Windows OS上で常時前面に表示されるフローティングアイコンを実装する `FloatingIcon` クラスを作成する。
tkinter Toplevelを使用した常時前面表示ウィンドウ、カスタムアイコン描画、高DPI対応、
複数モニター対応、透明背景、マウスイベント処理などの機能を提供する。

## 要件詳細

### REQ-001: フローティングアイコン表示
- Windows OS上でフローティングアイコンを常時表示する
- 他のアプリケーションウィンドウに隠れない常時前面表示
- ウィンドウの最小化・最大化の影響を受けない
- システムトレイとは独立した画面上の固定位置表示

### REQ-003: 前面表示維持
- フローティングアイコンを他のウィンドウより前面に表示する
- アクティブウィンドウが変更されても前面表示を維持
- フルスクリーンアプリケーション使用時の適切な動作
- システム再起動後の表示復旧

### REQ-201: 常時表示状態
- システムが起動状態にある場合、フローティングアイコンは常に表示される
- 意図しない非表示状態にならない
- ユーザーによる明示的な操作以外では非表示にならない

### NFR-004: 描画パフォーマンス
- フローティングアイコンの描画更新は60FPS以上
- CPUリソースを過度に消費しない効率的な描画
- メモリリークのない安定した描画処理
- 低スペックPCでも快適に動作

### NFR-201: 視認性
- フローティングアイコンは視認しやすいデザイン
- 背景色に関係なく識別可能な外観
- 適切なサイズとコントラスト
- ユーザビリティを重視した配色

### NFR-302: 高DPI対応
- システムは高DPI環境で正常に表示される
- DPIスケーリング設定に応じた適切なサイズ調整
- 解像度変更時の自動調整
- 複数モニター環境での適切な表示

## 実装インターフェース

### FloatingIcon クラス

```python
class FloatingIcon:
    def __init__(self, config_manager: ConfigManager):
        """フローティングアイコンの初期化"""
        pass
    
    def show(self) -> bool:
        """アイコンを表示する"""
        pass
    
    def hide(self) -> bool:
        """アイコンを非表示にする"""
        pass
    
    def update_position(self, x: int, y: int) -> bool:
        """アイコンの位置を更新する"""
        pass
    
    def update_size(self, size: int) -> bool:
        """アイコンのサイズを更新する"""
        pass
    
    def set_click_callback(self, callback: callable) -> None:
        """クリックコールバックを設定する"""
        pass
    
    def set_right_click_callback(self, callback: callable) -> None:
        """右クリックコールバックを設定する"""
        pass
    
    def is_visible(self) -> bool:
        """表示状態を確認する"""
        pass
    
    def get_position(self) -> tuple[int, int]:
        """現在の位置を取得する"""
        pass
    
    def get_size(self) -> int:
        """現在のサイズを取得する"""
        pass
    
    def refresh(self) -> None:
        """アイコンを再描画する"""
        pass
```

### IconStyle クラス

```python
@dataclass
class IconStyle:
    """アイコンスタイル設定"""
    size: int = 32
    background_color: str = "#4A90E2"
    border_color: str = "#2E5BBA"
    border_width: int = 2
    corner_radius: int = 8
    shadow_enabled: bool = True
    shadow_color: str = "#000000"
    shadow_offset: tuple[int, int] = (2, 2)
    opacity: float = 0.9
```

### DisplayInfo クラス

```python
@dataclass
class DisplayInfo:
    """ディスプレイ情報"""
    width: int
    height: int
    dpi_scale: float
    is_primary: bool
    bounds: tuple[int, int, int, int]  # (x, y, width, height)
```

## GUI要件

### tkinter実装要件
- tkinter.Toplevel を使用した独立ウィンドウ
- overrideredirect(True) による装飾なしウィンドウ
- wm_attributes("-topmost", True) による最前面表示
- wm_attributes("-transparentcolor") による透明背景サポート

### マウスイベント処理
- 左クリック: アプリケーション起動コールバック
- 右クリック: 設定メニュー表示コールバック
- マウスホバー: 視覚的なフィードバック
- ドラッグ&ドロップ: 位置変更機能（設定により有効/無効）

### 描画要件
- カスタムCanvasウィジェットでの描画
- アンチエイリアス対応の滑らかな図形
- グラデーション効果のサポート
- ドロップシャドウ効果

## 高DPI・マルチモニター対応

### DPI スケーリング
- システムDPI設定の自動検出
- tkinter.winfo_fpixels を使用したDPI計算
- アイコンサイズの動的調整
- フォントサイズのスケーリング

### マルチモニター対応
- 複数モニターの検出と情報取得
- モニター間での位置調整
- 解像度の異なるモニター間の移動対応
- プライマリ・セカンダリモニターの識別

### 動的調整
- システム設定変更時の自動調整
- ディスプレイ設定変更の検出
- 位置の自動補正
- サイズの動的調整

## パフォーマンス要件詳細

### 描画パフォーマンス
- 目標フレームレート: 60FPS以上
- 描画更新間隔: 16ms以内
- 静的状態での描画更新停止
- 変更時のみの部分再描画

### リソース使用量
- CPU使用率: 通常時1%以下
- メモリ使用量: 10MB以下
- GPU使用率: 最小限
- バッテリー消費への配慮

### 最適化手法
- ダブルバッファリングによるちらつき防止
- 不要な再描画の回避
- イベント駆動型の更新
- リソースの適切な管理

## 位置管理要件

### 座標系
- スクリーン座標系の使用
- 論理座標から物理座標への変換
- 負の座標値への対応
- 仮想スクリーン座標系のサポート

### 位置固定機能
- ConfigManagerとの連携による位置保存
- 起動時の位置復元
- ユーザーによる位置変更の記録
- 画面外配置時の自動補正

### 境界処理
- スクリーン境界での位置制限
- 画面外への移動防止
- マルチモニター環境での境界処理
- タスクバー等のシステム領域の考慮

## Windows固有要件

### ウィンドウ管理
- Windows API との連携
- Z-order の適切な管理
- アクティブウィンドウとの相互作用
- システム通知領域との区別

### システム統合
- Windows イベントの処理
- システム休止・復帰への対応
- ユーザーセッション変更への対応
- テーマ変更への対応

### アクセシビリティ
- Windows アクセシビリティ API への対応
- ハイコントラストモードのサポート
- スクリーンリーダー対応
- キーボードナビゲーション

## 統合要件

### ConfigManager連携
- 位置情報の永続化
- サイズ設定の保存・読込
- スタイル設定の管理
- 表示状態の記憶

### AppLauncher連携
- クリックイベントでのアプリケーション起動
- 起動結果の視覚的フィードバック
- エラー時の表示処理
- パフォーマンス監視

### システムトレイとの協調
- システムトレイとフローティングアイコンの両立
- 機能の重複回避
- ユーザー設定による表示切り替え
- 一貫したユーザー体験

## エラーハンドリング要件

### 描画エラー
- Canvas 描画エラーの処理
- リソース不足時の対応
- グラフィックドライバー問題への対応
- 色深度問題への対応

### ウィンドウシステムエラー
- Toplevel 作成失敗の処理
- ウィンドウマネージャーとの競合
- 表示デバイス変更時の処理
- システムリソース枯渇への対応

### 設定エラー
- 無効な座標値の補正
- 無効なサイズ値の補正
- 設定ファイル破損時の処理
- デフォルト値への自動復帰

## テスト要件

### 視覚テスト
- 実際の画面表示確認
- 複数解像度での表示確認
- 高DPI環境での表示確認
- マルチモニター環境での表示確認

### 機能テスト
- 位置変更の動作確認
- サイズ変更の動作確認
- イベント処理の確認
- 設定保存・読込の確認

### パフォーマンステスト
- フレームレート測定
- CPU・メモリ使用率測定
- 長時間稼働テスト
- リソースリーク検出

## 完了条件

1. **機能要件**:
   - [ ] フローティングアイコンが正常に表示される
   - [ ] 常時前面表示が維持される
   - [ ] マウスイベントが正しく処理される
   - [ ] 位置・サイズ変更が正常に動作する

2. **品質要件**:
   - [ ] 60FPS以上の描画パフォーマンス
   - [ ] 高DPI環境での正常表示
   - [ ] マルチモニター対応
   - [ ] 長時間安定動作

3. **統合要件**:
   - [ ] ConfigManager との連携
   - [ ] AppLauncher との連携
   - [ ] 他システムとの協調動作
   - [ ] アクセシビリティ対応

## 実装方針

### 段階的実装
1. **基本ウィンドウ**: tkinter Toplevel の基本表示
2. **描画機能**: Canvas での図形描画
3. **イベント処理**: マウスクリック・ホバー処理
4. **位置管理**: 座標の保存・復元
5. **高DPI対応**: DPI スケーリング対応
6. **統合機能**: 他モジュールとの連携

### 品質重視
- すべての機能の包括的テスト
- パフォーマンスの継続的監視
- ユーザビリティの重視
- アクセシビリティの確保